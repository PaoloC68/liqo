---
title: Authentication
weight: 1
---

### Overview

The _Authentication_ and _Authorization_ mechanisms are in charge of the approval of the identities to be used by the remote clusters to manage resources in the local one.
In addition, they manage the permissions related to this identity given the peering phase.
The remote cluster has to have only basic permissions when the peering is not established, and it requires more permissions when the peering is complete.

### Authentication Token

Liqo requires, by default, a pre-authentication step before issuing an identity for a remote cluster.
At installation time, it generates a random secret token and stores it in a _Kubernetes Secret_; when a remote cluster needs to have a valid identity to contact the local API Server, it has to provide this token and the _Certificate Signing Request (CSR)_.

#### The Local Token

The generated local token is stored in a Secret in the _Liqo Namespace_ like this one:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: auth-token
  namespace: liqo
type: Opaque
data:
  token: MmY0MWYxM2RmYzhhNmIwMzc2ZDU...VlMGMxMzA2OGQxZTU=
```

It has to be kept confidential and shared only with the other Liqo clusters that we want to allow to peer and offload their workloads to the local cluster.

#### Add the Token for a Remote Cluster

When a cluster needs to have a valid identity in another cluster, it needs to send the correct authentication token.
The cluster administrator has to provide this token to the Liqo control plane storing it in a _Kubernetes Secret_ in the _Liqo Namespace_ (`liqo` by default).
This Secret has to be in the form:

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    discovery.liqo.io/auth-token: ""
    discovery.liqo.io/cluster-id: 2a25eeff-48cb-4578-b772-0f5ec9ee4264
  name: remote-token-2a25eeff-48cb-4578-b772-0f5ec9ee4264
  namespace: liqo
type: Opaque
data:
  token: MmY0MWYxM2RmYzhhNmIwMzc2ZDU...VlMGMxMzA2OGQxZTU=
```

* the __name__ of the _Secret_ has to be unique and not to cause name collisions. Here we decided to use a prefix (_remote-token-_) followed by the remote cluster id; but this is not required by the _Liqo Control Plane (LCP)_ since it does not get it by name.
* the __namespace__ has to be the one where Liqo is running.
* the labels have to contain two values:
  * `discovery.liqo.io/auth-token` to indicate that this _Secret_ contains a remote authentication token.
  * `discovery.liqo.io/cluster-id` to indicate which remote cluster this token is to be used with.
* the __token__ key contains the token generated by the remote cluster.

### Identity Creation

The identity creation process goal is to create and validate an identity to allow the _Liqo Control Plane (LCP)_ to manage and update its resources on the peered cluster successfully.

#### In the Local Cluster

The _ForeignCluster Operator_ triggers reconciliations over the _ForeignCluster CRs_ when there are create or update events over the Secrets labeled with the `discovery.liqo.io/auth-token` and the `discovery.liqo.io/cluster-id` labels.
The reconciler checks if there is no available identity related to the specific remote cluster, and, in that case, it retrieves a new one by:

1. create a private/public ECDSA key pair and a related Certificate Signing Request (CSR). The signing request contains the _local clusterID_ as the commonName and `liqo.io` as organization. These values are respectively mapped to Kubernetes user and group ([see here for more details](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)).
2. store the keys and the CSR in a Secret in the Liqo Tenant Namespace.
3. read the Authentication token related to the remote clusterID from the Secret.
4. send the local Authentication token, the remote Authentication token and the CSR to the remote cluster.
5. store the retrieved certificate in the Secret in the Liqo Tenant Namespace.

At the end of the process in the local Tenant Namespace we will found a Secret similar to that one:

```yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    discovery.liqo.io/certificate-available: "true"
    discovery.liqo.io/cluster-id: 2a25eeff-48cb-4578-b772-0f5ec9ee4264
    discovery.liqo.io/local-identity: "true"
  name: liqo-identity-tg76c
  namespace: liqo-tenant-2a25eeff-48cb-4578-b772-0f5ec9ee4264
type: Opaque
data:
  apiServerCa: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0t...UVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  apiServerUrl: aHR0cHM6Ly8xNzIuMTguMC40OjY0NDM=
  certificate: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tL...BTdkFiTUxICmZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  csr: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNUL...5XSQpUNzhPCi0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
  namespace: bGlxby10ZW5hbnQtNDhiYjA3YjctYTA1NC00NGEwLWFhM2ItMTZhOTAxNGNmZTVi
  private-key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tL...S1FTkQgUFJJVkFURSBLRVktLS0tLQo=
```

In addition to the certificate, the remote cluster sends us:

* the __apiServerUrl__: the URL where to contact the remote API Server.
* the __namespace__: the name of the remote Tenant Namespace, where the resources has to be replicated.

We can find them base64-encoded in the Secret.

#### In the Remote Cluster

When the _Authentication Service_ receives an identity request, it has to validate if it is coming from an allowed cluster, in that case it has to issue the certificate and send it to the requiring cluster.

1. check that the provided Authentication token matches the local stored token.
2. ensure the existence of a Tenant Namespace for that cluster.
3. check that we had never issued any other certificate for the same clusterID. This is done for security reasons, to prevent that a third party to be able to get an identity with the same clusterID of another one being then able to manage its resources.
4. make the CSR approved by the Kubernetes `kubernetes.io/kube-apiserver-client` signer ([see here for more details](https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers)).
5. bind the basic permissions to the user with name equal to the remote clusterID in the Tenant Namespace.

### Permission Management

The permissions granted to the Liqo identity change over the time when the peering phase changes. We can identify three groups of permissions:

* __basic peering permissions__: always enabled, allow the user to manage the ResourceRequest CRs in its own Liqo Tenant Namespace. It is required to start a peering.
* __incoming peering permissions__: enabled when the remote cluster is offloading jobs to the local one, allow the user to manage network resources (i.e. NetworkConfig CRs) in its own Liqo Tenant Namespace.
* __outgoing peering permissions__: enabled when the local cluster is offloading jobs to the remote one, allow the user to manage network resources (i.e. NetworkConfig CRs) and ResourceOffers in its own Liqo Tenant Namespace.

These permissions groups can be simultaneously enabled in the case of a Bidirectional Peering.
